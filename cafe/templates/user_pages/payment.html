<!DOCTYPE html>
<html lang="en">
<head>
    <!-- jQuery -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
    <!-- iamport.payment.js -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <script>
        var IMP = window.IMP; 
        IMP.init("YOUR_IMP_KEY"); // 아임포트 가맹점 식별코드

        var productName = "Order Items"; // 기본 상품 이름
        var counter = "{{ counter }}";
        var total = "{{ total }}"; 

        var today = new Date();   
        var hours = today.getHours(); // 시
        var minutes = today.getMinutes();  // 분
        var seconds = today.getSeconds();  // 초
        var milliseconds = today.getMilliseconds();
        var makeMerchantUid = hours +  minutes + seconds + milliseconds;

        function requestPay() {
            IMP.request_pay({
                pg : 'kcp',
                pay_method : 'card',
                merchant_uid: "IMP"+makeMerchantUid, 
                name : productName,
                amount : total,
                buyer_email : 'buyer@example.com',
                buyer_name : '구매자 이름',
                buyer_tel : '010-1234-5678',
                buyer_addr : '서울특별시 강남구 삼성동',
                buyer_postcode : '123-456'
            }, function (rsp) { // callback
                if (rsp.success) {
                    // 결제 성공 시 서버에 결제 정보 전송
                    $.ajax({
                        url: "{% url 'payment_complete' %}",
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        data: {
                            imp_uid: rsp.imp_uid,
                            merchant_uid: rsp.merchant_uid,
                            paid_amount: rsp.paid_amount,
                            status: rsp.status,
                            cart_items: JSON.stringify({{ cart_items|safe }}),
                            total_price: total,
                            order_type: "{{ order_type }}"
                        },
                        success: function(data) {
                            alert('결제가 완료되었습니다.');
                            window.location.href = "{% url 'order_list' %}";
                        },
                        error: function(err) {
                            alert('결제 처리 중 오류가 발생했습니다.');
                        }
                    });
                } else {
                    alert('결제가 실패하였습니다.');
                }
            });
        }
    </script>
    <meta charset="UTF-8">
    <title>Sample Payment</title>
</head>
<body>
    <button onclick="requestPay()">결제하기</button> <!-- 결제하기 버튼 생성 -->
</body>
</html>
